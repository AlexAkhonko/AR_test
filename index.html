<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Handwritten Symbols AR Overlay</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; background: #111; color: #fff; }
    #wrap { position: relative; max-width: 100vw; max-height: 100vh; overflow: hidden; }
    video { width: 100vw; height: auto; display: block; }
    #overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }
    .symbol-box {
      position: absolute;
      border: 2px solid #0f0;
      box-shadow: 0 0 15px #0f0;
      background: rgba(0,255,0,0.1);
    }
    .image-overlay {
      position: absolute;
      border: 2px solid #0f0;
      box-shadow: 0 0 15px #0f0;
      overflow: hidden;
      transform: translate(-50%, -50%);
    }
    .image-overlay img {
      width: 100%; height: 100%; object-fit: cover;
    }
    #list {
      padding: 8px; font-size: 14px;
      background: rgba(0,0,0,0.8);
      max-height: 200px; overflow-y: auto;
    }
    button { margin: 4px; padding: 6px 10px; font-size: 14px; }
    #status { font-size: 12px; opacity: 0.7; }
  </style>
</head>
<body>
<div id="wrap">
  <video id="video" autoplay playsinline></video>
  <div id="overlay"></div>
</div>

<div id="list">
  <div id="status">Загрузка Tesseract.js…</div>
  <div id="results"></div>
  <button id="startBtn">Старт</button>
  <button id="stopBtn" disabled>Стоп</button>
</div>

<script>
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const statusEl = document.getElementById('status');
  const resultsEl = document.getElementById('results');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');

  let stream = null;
  let running = false;
  let worker = null;
  let images = {}; // твои картинки car.png и т.д.

  // Символ → картинка (нарисуй ★1, A1, B2 и т.д.)
  const symbolMap = {
    '★1': 'car.png',
    '★2': 'home1.png',
    '★3': 'phot.png',
    '★4': 'red.jpg',
    '★5': 'tuf.jpg',
    '★6': 'win.jpg',
    'a1': 'car.png',
    'b2': 'home1.png'
  };

  // Предзагружаем картинки
  async function preloadImages() {
    for (const [symbol, filename] of Object.entries(symbolMap)) {
      const img = new Image();
      img.src = filename;
      await new Promise(resolve => {
        img.onload = () => { images[symbol] = img; resolve(); };
        img.onerror = resolve;
      });
    }
  }

  async function initTesseract() {
    statusEl.textContent = 'Инициализация Tesseract.js…';
    worker = await Tesseract.createWorker('eng', 1, {
      logger: m => statusEl.textContent = `Tesseract: ${m.status} ${Math.round(m.progress * 100)}%`
    });
    await preloadImages();
    statusEl.textContent = 'Готово! Нарисуй ★1, ★2, A1, B2 фломастером на коробках.';
  }

  async function start() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
      });
      video.srcObject = stream;
      running = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      statusEl.textContent = 'Сканирование символов…';
      requestAnimationFrame(loop);
    } catch (e) {
      statusEl.textContent = 'Ошибка камеры: ' + e.message;
    }
  }

  function stop() {
    running = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    if (stream) stream.getTracks().forEach(t => t.stop());
    video.srcObject = null;
    clearOverlay();
  }

  function clearOverlay() {
    overlay.innerHTML = '';
  }

  function drawSymbolOverlay(symbol, x, y, width, height) {
    clearOverlay();
    const rect = video.getBoundingClientRect();
    const scaleX = rect.width / video.videoWidth;
    const scaleY = rect.height / video.videoHeight;

    // Рамка вокруг символа
    const box = document.createElement('div');
    box.className = 'symbol-box';
    box.style.left = (x * scaleX) + 'px';
    box.style.top = (y * scaleY) + 'px';
    box.style.width = (width * scaleX) + 'px';
    box.style.height = (height * scaleY) + 'px';
    box.textContent = symbol;
    overlay.appendChild(box);

    // Картинка вместо символа
    if (images[symbol]) {
      const imageDiv = document.createElement('div');
      imageDiv.className = 'image-overlay';
      imageDiv.style.width = (width * 1.5 * scaleX) + 'px';
      imageDiv.style.height = (height * 1.5 * scaleY) + 'px';
      imageDiv.style.left = ((x + width / 2) * scaleX) + 'px';
      imageDiv.style.top = ((y + height / 2) * scaleY) + 'px';
      
      const img = document.createElement('img');
      img.src = images[symbol].src;
      imageDiv.appendChild(img);
      overlay.appendChild(imageDiv);
    }
  }

  async function loop() {
    if (!running || video.readyState !== video.HAVE_ENOUGH_DATA) {
      if (running) requestAnimationFrame(loop);
      return;
    }

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    try {
      // Tesseract.js на весь кадр (можно оптимизировать по ROI)
      const { data: { text, words } } = await worker.recognize(canvas);
      
      if (words.length > 0) {
        // Берём самый уверенный символ
        const bestWord = words.reduce((best, word) => 
          word.confidence > best.confidence ? word : best
        );
        
        const symbol = bestWord.text.trim().toLowerCase();
        if (symbolMap[symbol]) {
          drawSymbolOverlay(symbol, 
            bestWord.bbox.x0, bestWord.bbox.y0, 
            bestWord.bbox.x1 - bestWord.bbox.x0, 
            bestWord.bbox.y1 - bestWord.bbox.y0
          );
          resultsEl.innerHTML = `<strong>★ ${symbol} → ${symbolMap[symbol]}</strong>`;
          return;
        }
      }
      
      clearOverlay();
      resultsEl.textContent = 'Символы не найдены. Попробуй ★1, A1, B2…';
    } catch (e) {
      console.error('Tesseract error:', e);
    }

    if (running) requestAnimationFrame(loop);
  }

  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);

  initTesseract();
</script>
</body>
</html>
