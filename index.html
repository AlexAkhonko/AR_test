<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Multi QR AR Overlay</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #111; color: #fff; }
    #wrap { position: relative; max-width: 100vw; max-height: 100vh; overflow: hidden; }
    video {
      width: 100vw;
      height: auto;
      display: block;
    }
    #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }
    .box {
      position: absolute;
      border: 2px solid #0f0;
      box-shadow: 0 0 10px #0f0;
    }
    .icon {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(0,0,0,0.7);
      border: 2px solid #0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0f0;
      font-size: 20px;
      font-weight: bold;
      transform: translate(-50%, -50%);
    }
    #list {
      padding: 8px;
      font-size: 14px;
      background: rgba(0,0,0,0.7);
    }
    #status { font-size: 12px; opacity: 0.7; }
    button {
      margin: 4px;
      padding: 6px 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
<div id="wrap">
  <video id="video" autoplay playsinline></video>
  <div id="overlay"></div>
</div>

<div id="list">
  <div id="status">Ожидание камеры…</div>
  <div id="results"></div>
  <button id="startBtn">Старт</button>
  <button id="stopBtn" disabled>Стоп</button>
</div>

<script>
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const statusEl = document.getElementById('status');
  const resultsEl = document.getElementById('results');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');

  let stream = null;
  let running = false;
  let detector = null;

  // Простые "картинки" для оверлея — буквы. Можно заменить на реальные img по rawValue.
  const icons = ['A','B','C','D','E','F','G','H','I','J'];

  async function initDetector() {
    if ('BarcodeDetector' in window) {
      const formats = await BarcodeDetector.getSupportedFormats();
      detector = new BarcodeDetector({ formats: formats.includes('qr_code') ? ['qr_code'] : formats });
      statusEl.textContent = 'BarcodeDetector доступен, жми Старт.';
    } else {
      statusEl.textContent = 'BarcodeDetector не поддерживается в этом браузере.';
    }
  }

  async function start() {
    if (!detector) {
      alert('BarcodeDetector недоступен в этом браузере.');
      return;
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
      });
      video.srcObject = stream;
      running = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      statusEl.textContent = 'Сканирование… наведи на несколько QR кодов.';
      requestAnimationFrame(loop);
    } catch (e) {
      console.error(e);
      statusEl.textContent = 'Ошибка доступа к камере: ' + e.message;
    }
  }

  function stop() {
    running = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    clearOverlay();
  }

  function clearOverlay() {
    overlay.innerHTML = '';
  }

  function drawOverlay(barcodes) {
    clearOverlay();
    const rect = video.getBoundingClientRect();
    const scaleX = rect.width / video.videoWidth;
    const scaleY = rect.height / video.videoHeight;

    barcodes.forEach((code, idx) => {
      const { x, y, width, height } = code.boundingBox;

      // рамка
      const box = document.createElement('div');
      box.className = 'box';
      box.style.left = (x * scaleX) + 'px';
      box.style.top = (y * scaleY) + 'px';
      box.style.width = (width * scaleX) + 'px';
      box.style.height = (height * scaleY) + 'px';
      overlay.appendChild(box);

      // "картинка" — иконка над кодом
      const icon = document.createElement('div');
      icon.className = 'icon';
      const centerX = (x + width / 2) * scaleX;
      const topY = (y - 10) * scaleY; // чуть выше рамки
      icon.style.left = centerX + 'px';
      icon.style.top = topY + 'px';
      icon.textContent = icons[idx % icons.length]; // A,B,C...
      overlay.appendChild(icon);
    });
  }

  async function loop() {
    if (!running || video.readyState !== video.HAVE_ENOUGH_DATA) {
      if (running) requestAnimationFrame(loop);
      return;
    }

    // Создаём временный canvas для детекции (без отображения)
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    try {
      const barcodes = await detector.detect(canvas);
      if (barcodes.length > 0) {
        drawOverlay(barcodes);
        const texts = barcodes.map((b, i) => `${i + 1}. ${b.rawValue}`);
        resultsEl.textContent = 'Найдено: ' + barcodes.length + '\n' + texts.join('\n');
      } else {
        clearOverlay();
        resultsEl.textContent = 'Коды не найдены.';
      }
    } catch (e) {
      console.error(e);
      statusEl.textContent = 'Ошибка детектора: ' + e.message;
    }

    if (running) requestAnimationFrame(loop);
  }

  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);

  initDetector();
</script>
</body>
</html>
